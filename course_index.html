<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>コースルート</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #f5f5f5;
    }

    .grid {
      display: grid;
      grid-template-rows: auto 1fr;
      grid-template-columns: 1fr 1fr;
      /* 左:操作, 右:マップ+パレット */
      height: 100vh;
    }

    header {
      grid-column: 1 / -1;
      padding: 16px 20px 0;
    }

    .controls {
      grid-row: 2;
      grid-column: 1;
      padding: 12px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow-y: auto;
    }

    .viewer {
      grid-row: 2;
      grid-column: 2;
      display: flex;
      flex-direction: row;
      /* ← マップとパレットを横並び */
      background: #fff;
      border-left: 1px solid #ddd;
      overflow: hidden;
    }

    .viewer iframe {
      flex: 1;
      /* マップが右半分の左側に広がる */
      border: none;
    }

    label {
      margin-right: 8px;
    }

    select {
      margin: 4px;
      padding: 6px 8px;
    }

    .memo {
      display: flex;
      flex-direction: column;
    }

    .memo label {
      margin-bottom: 4px;
      font-weight: bold;
    }

    .memo textarea {
      resize: vertical;
      min-height: 96px;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
    }

    /* ルートメモ・雑感メモは共通の高さ (96px) */
    #routeMemo,
    #noteMemo {
      min-height: 96px;
    }

    /* ショートカット解説だけ高くする (144px ≒ 12行) */
    #scMemo {
      min-height: 144px;
    }



    .ranking {
      border: 1px solid #ccc;
      padding: 8px;
      background: #fff;
      border-radius: 6px;
    }

    .ranking h3 {
      margin: 0 0 8px 0;
      font-size: 14px;
    }

    .ranking-grid {
      display: grid;
      grid-template-columns: auto 1fr auto 1fr;
      gap: 6px 10px;
      max-height: 190px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .rank-label {
      display: flex;
      align-items: center;
      font-size: 13px;
      white-space: nowrap;
    }

    .rank-select {
      min-width: 140px;
    }

    #auth-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .auth-box {
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      text-align: center;
      width: 320px;
    }

    #password-input {
      width: 90%;
      padding: 10px;
      margin: 15px 0;
      font-size: 16px;
    }

    #auth-submit-btn {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAui77LEU8EbPbyKbyXQhTvRPbMJQdLvg0",
      authDomain: "mkworld-a3de2.firebaseapp.com",
      projectId: "mkworld-a3de2",
      storageBucket: "mkworld-a3de2.firebasestorage.app",
      messagingSenderId: "842699753240",
      appId: "1:842699753240:web:d83dbe63dd815f28c4006d",
      measurementId: "G-NSMKQS9HHG"
    };

    // Firebaseの初期化
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script src="courses.js"></script>
  <div id="auth-overlay">
    <div class="auth-box">
      <h2 id="auth-title">パスワード認証</h2>
      <p id="auth-message">このセッションにアクセスするためのパスワードを入力してください。</p>
      <input type="password" id="password-input" placeholder="パスワード">
      <button id="auth-submit-btn">入室</button>
      <p id="error-message" style="color: red;"></p>
    </div>
  </div>
  <div class="grid">
    <header>
      <h1 style="margin:0;">コースルート</h1>
    </header>

    <div class="controls">
      <div>
        <label>始点：
          <select id="start"></select>
        </label>
        <button id="swapBtn" title="始点と終点を入れ替え">↔</button>
        <label>終点：
          <select id="end"></select>
        </label>
        <button id="exportBtn">データ全出力</button>
        <button id="importBtn">データ読込</button>
        <input type="file" id="importFile" accept="application/json" style="display:none;">


      </div>

      <div class="ranking">
        <h3>終点コース順位（始点ごとに保存）</h3>
        <div id="rankingGrid" class="ranking-grid"></div>
      </div>

      <div class="memo">
        <label for="routeMemo">ルートメモ</label>
        <textarea id="routeMemo"></textarea>
      </div>

      <div class="memo">
        <label for="scMemo">ショートカット解説</label>
        <textarea id="scMemo"></textarea>
      </div>

      <div class="memo">
        <label for="noteMemo">雑感メモ</label>
        <textarea id="noteMemo"></textarea>
      </div>
    </div>

    <div class="viewer">
      <iframe id="mapFrame"></iframe>
      <!-- パレットは map_editor_fixa.html 内にあるので別枠不要 -->
    </div>
  </div>

  <script src="courses.js"></script>
  <script>
    //================================================================
    // 1. グローバル変数と要素の取得
    //================================================================
    const startEl = document.getElementById('start');
    const endEl = document.getElementById('end');
    const mapFrame = document.getElementById('mapFrame');
    const routeMemo = document.getElementById('routeMemo');
    const noteMemo = document.getElementById('noteMemo');
    const scMemo = document.getElementById('scMemo');
    const rankingGrid = document.getElementById('rankingGrid');
    const mainContent = document.querySelector('.grid');
    const authOverlay = document.getElementById('auth-overlay');
    const authTitle = document.getElementById('auth-title');
    const authMessage = document.getElementById('auth-message');
    const passwordInput = document.getElementById('password-input');
    const authSubmitBtn = document.getElementById('auth-submit-btn');
    const errorMessage = document.getElementById('error-message');

    let sessionId;
    const clientInstanceId = Math.random().toString(36).substring(2);
    const keyMemo = (s, e) => `memo_${s}_${e}`;
    const keyRanking = (s) => `ranking_${s}`;
    const keyLastSel = "last_selection";

    //================================================================
    // 2. UIの初期化と更新を行うコア関数
    //================================================================
    function initializeUI() {
      mainContent.style.display = 'grid';
      authOverlay.style.display = 'none';

      const starts = [...new Set(routes.map(r => r[0]))];
      startEl.innerHTML = '';
      starts.forEach(jp => startEl.add(new Option(jp, jp)));

      const raw = localStorage.getItem(keyLastSel);
      if (raw) {
        try {
          const obj = JSON.parse(raw);
          if (starts.includes(obj.start)) startEl.value = obj.start;
        } catch { }
      }

      refreshEnds();
      listenForChanges();
    }

    function refreshEnds() {
      const s = startEl.value;
      const currentEnd = endEl.value;
      endEl.innerHTML = "";
      const ends = endsForStart(s);
      ends.forEach(e => endEl.add(new Option(e, e)));

      if (ends.includes(currentEnd)) {
        endEl.value = currentEnd;
      } else {
        endEl.value = ends[0] || "";
      }

      renderRanking();
      updateMap();
    }

    function updateMap() {
      const s = startEl.value, e = endEl.value;
      if (!e) return;

      const newSrc = `map_editor_fixa.html?start=${encodeURIComponent(s)}&end=${encodeURIComponent(e)}`;
      if (mapFrame.getAttribute('src') !== newSrc) {
        mapFrame.src = newSrc;
      }

      localStorage.setItem(keyLastSel, JSON.stringify({ start: s, end: e }));
      loadMemos();
      saveDataToFirebase();
    }

    //================================================================
    // 3. データの保存と読み込み（localStorage <-> UI）
    //================================================================
    function saveMemos() {
      localStorage.setItem(keyMemo(startEl.value, endEl.value), JSON.stringify({
        route: routeMemo.value, sc: scMemo.value, note: noteMemo.value
      }));
    }

    function loadMemos() {
      const raw = localStorage.getItem(keyMemo(startEl.value, endEl.value));
      const obj = raw ? JSON.parse(raw) : {};
      routeMemo.value = obj.route || '';
      scMemo.value = obj.sc || '';
      noteMemo.value = obj.note || '';
    }

    function renderRanking() {
      rankingGrid.innerHTML = '';
      const s = startEl.value, ends = endsForStart(s), rank = getRanking(s);
      ends.forEach((e, i) => {
        const label = document.createElement('div');
        label.className = 'rank-label';
        label.textContent = `${i + 1}位`;
        const sel = document.createElement('select');
        ends.forEach(optionEnd => sel.add(new Option(optionEnd, optionEnd)));
        sel.value = rank[i] || e;
        sel.addEventListener('change', () => setRankAt(i, sel.value));
        rankingGrid.appendChild(label);
        rankingGrid.appendChild(sel);
      });
    }

    function setRankAt(pos, value) {
      const s = startEl.value;
      const rank = getRanking(s).filter(v => v !== value);
      rank.splice(pos, 0, value);
      localStorage.setItem(keyRanking(s), JSON.stringify(rank.slice(0, endsForStart(s).length)));
      renderRanking();
      saveDataToFirebase();
    }

    function getRanking(s) {
      const ends = endsForStart(s);
      const raw = localStorage.getItem(keyRanking(s));
      let rank = raw ? JSON.parse(raw) : [];
      const seen = new Set(rank);
      return [...rank, ...ends.filter(e => !seen.has(e))];
    }

    function endsForStart(s) { return routes.filter(r => r[0] === s).map(r => r[1]); }

    //================================================================
    // 4. Firebase連携と認証
    //================================================================
    function saveDataToFirebase() {
      if (!sessionId) return;
      const allData = {};
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        allData[key] = localStorage.getItem(key);
      }
      db.collection('sessions').doc(sessionId).update({
        data: JSON.stringify(allData),
        senderId: clientInstanceId
      });
    }

    function listenForChanges() {
      if (!sessionId) return;
      db.collection('sessions').doc(sessionId).onSnapshot((doc) => {
        if (doc.exists && doc.data().senderId !== clientInstanceId) {
          localStorage.clear();
          const remoteData = JSON.parse(doc.data().data);
          for (const [key, value] of Object.entries(remoteData)) {
            localStorage.setItem(key, value);
          }
          initializeUI();
        }
      });
    }

    async function handleAuthentication() {
      const params = new URLSearchParams(window.location.search);
      sessionId = params.has('session') ? params.get('session') : Math.random().toString(36).substring(2, 12);
      if (!params.has('session')) {
        window.history.replaceState(null, '', `?session=${sessionId}`);
      }

      if (sessionStorage.getItem('authenticated_session_id') === sessionId) {
        initializeUI();
        return;
      }

      mainContent.style.display = 'none';
      authOverlay.style.display = 'flex';

      const docRef = db.collection('sessions').doc(sessionId);
      const doc = await docRef.get();

      if (!doc.exists) { // 新規セッション
        authTitle.textContent = '新しいセッションを作成';
        authMessage.textContent = 'この部屋の合言葉（パスワード）を設定してください。';
        authSubmitBtn.textContent = '作成して入室';
        authSubmitBtn.onclick = async () => {
          const password = passwordInput.value;
          if (password.length < 4) {
            errorMessage.textContent = 'パスワードは4文字以上で設定してください。'; return;
          }
          localStorage.clear();
          await docRef.set({ password: password, data: '{}', senderId: clientInstanceId });
          sessionStorage.setItem('authenticated_session_id', sessionId);
          location.reload();
        };
      } else { // 既存セッション
        const correctPassword = doc.data().password;
        authSubmitBtn.onclick = () => {
          if (passwordInput.value === correctPassword) {
            localStorage.clear();
            const remoteData = JSON.parse(doc.data().data || '{}');
            for (const [key, value] of Object.entries(remoteData)) {
              localStorage.setItem(key, value);
            }
            sessionStorage.setItem('authenticated_session_id', sessionId);
            location.reload();
          } else {
            errorMessage.textContent = 'パスワードが違います。';
          }
        };
      }
    }

    //================================================================
    // 5. イベントリスナーの設定
    //================================================================
    startEl.addEventListener('change', refreshEnds);
    endEl.addEventListener('change', updateMap);
    routeMemo.addEventListener('input', () => { saveMemos(); saveDataToFirebase(); });
    scMemo.addEventListener('input', () => { saveMemos(); saveDataToFirebase(); });
    noteMemo.addEventListener('input', () => { saveMemos(); saveDataToFirebase(); });
    window.addEventListener('message', (event) => {
      if (event.data === 'map_updated') saveDataToFirebase();
    });

    // データ入出力ボタン
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    if (exportBtn && importBtn && importFile) {
      exportBtn.addEventListener('click', () => {
        const allData = {};
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          allData[key] = localStorage.getItem(key);
        }
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' }));
        a.download = `session_${sessionId}_backup.json`;
        a.click();
        a.remove();
      });
      importBtn.addEventListener('click', () => {
        if (confirm('警告：現在のセッションデータが上書きされます。よろしいですか？')) {
          importFile.click();
        }
      });
      importFile.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const dataToImport = JSON.parse(event.target.result);
            localStorage.clear();
            for (const [key, value] of Object.entries(dataToImport)) {
              localStorage.setItem(key, value);
            }
            saveDataToFirebase();
            alert('データを読み込みました。ページを更新します。');
            location.reload();
          } catch (err) { alert('読み込みに失敗しました: ' + err.message); }
        };
        reader.readAsText(file);
        e.target.value = '';
      });
    }
    //================================================================
    // 6. 起動処理
    //================================================================
    window.onload = function () {
      handleAuthentication();
    };
  </script>

</body>

</html>